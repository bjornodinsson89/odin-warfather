// ============================================================
// ODIN WARFATHER â€” Drawer UI (Tab-Aware)
// ============================================================

(function () {
    'use strict';

    if (window.WarfatherDrawer) return;

    class WarfatherDrawer {
        constructor() {
            this.isOpen = false;
            this.tabs = {};
            this.activeTab = null;
            this._observer = null;
        }

        init() {
            this.injectButton();
            this.injectDrawer();
            this.injectTabBar();
            this.startObserver();
        }

        // -------------------------------
        // Mutation observer: reinsert if Torn nukes our DOM
        // -------------------------------
        startObserver() {
            if (this._observer) return;

            this._observer = new MutationObserver(() => {
                if (!document.getElementById("wf-header-button")) {
                    this.injectButton();
                }
                if (!document.getElementById("wf-drawer")) {
                    this.injectDrawer();
                    this.injectTabBar();
                }
                if (!document.getElementById("wf-tab-bar")) {
                    this.injectTabBar();
                }
            });

            this._observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // -------------------------------
        // Button (bear icon, bottom-left)
        // -------------------------------
        injectButton() {
            if (document.getElementById("wf-header-button")) return;

            const btn = document.createElement("div");
            btn.id = "wf-header-button";

            const img = document.createElement("img");
            img.id = "wf-bear-icon";
            img.src = "https://raw.githubusercontent.com/bjornodinsson89/odin-warfather/main/assets/Bear-head.png";

            btn.appendChild(img);
            btn.addEventListener("click", () => this.toggle());

            document.body.appendChild(btn);
        }

        // -------------------------------
        // Drawer container
        // -------------------------------
        injectDrawer() {
            if (document.getElementById("wf-drawer")) return;

            const drawer = document.createElement("div");
            drawer.id = "wf-drawer";

            const content = document.createElement("div");
            content.id = "wf-tab-content";

            drawer.appendChild(content);
            document.body.appendChild(drawer);
        }

        // -------------------------------
        // Tab bar container
        // -------------------------------
        injectTabBar() {
            let drawer = document.getElementById("wf-drawer");
            if (!drawer) {
                this.injectDrawer();
                drawer = document.getElementById("wf-drawer");
            }
            if (!drawer) return;

            if (document.getElementById("wf-tab-bar")) return;

            const bar = document.createElement("div");
            bar.id = "wf-tab-bar";
            drawer.insertBefore(bar, drawer.firstChild);
        }

        // -------------------------------
        // Called by integrator to register tabs
        // -------------------------------
        addTab(name, label) {
            if (this.tabs[name]) return;

            const bar = document.getElementById("wf-tab-bar");
            const contentArea = document.getElementById("wf-tab-content");
            if (!bar || !contentArea) return;

            // Tab button
            const btn = document.createElement("div");
            btn.className = "wf-tab-button";
            btn.dataset.tab = name;
            btn.textContent = label;
            btn.addEventListener("click", () => this.switchTab(name));
            bar.appendChild(btn);

            // Tab pane
            const pane = document.createElement("div");
            pane.className = "wf-tab-pane";
            pane.id = `wf-tab-${name}`;
            pane.style.display = "none";
            contentArea.appendChild(pane);

            this.tabs[name] = { btn, pane };

            // First tab auto-activate
            if (!this.activeTab) {
                this.switchTab(name);
            }
        }

        // -------------------------------
        // Switch active tab
        // -------------------------------
        switchTab(name) {
            if (!this.tabs[name]) return;

            Object.values(this.tabs).forEach(({ btn, pane }) => {
                btn.classList.remove("wf-active");
                pane.style.display = "none";
            });

            const { btn, pane } = this.tabs[name];
            btn.classList.add("wf-active");
            pane.style.display = "block";
            this.activeTab = name;
        }

        // -------------------------------
        // Toggle drawer open/closed
        // -------------------------------
        toggle() {
            const drawer = document.getElementById("wf-drawer");
            const btn = document.getElementById("wf-header-button");
            if (!drawer || !btn) return;

            this.isOpen = !this.isOpen;

            drawer.classList.toggle("wf-open", this.isOpen);
            btn.classList.toggle("wf-open", this.isOpen);
        }
    }

    window.WarfatherDrawer = new WarfatherDrawer();

})();
